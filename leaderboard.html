<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard | Fallacy Spotter - VideoBate</title>
  <meta name="description" content="See the top fallacy spotters and compete for the highest score!">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
  <style>
    :root {
      --bg-dark: #0f0f14;
      --bg-card: #1a1a24;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-red: #ef4444;
      --accent-gold: #ffd700;
      --accent-cyan: #00d4ff;
      --accent-green: #22c55e;
      --accent-purple: #8b5cf6;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Navigation */
    .nav {
      background: rgba(15, 15, 20, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--accent-red);
      text-decoration: none;
    }
    .logo span { color: var(--text-primary); }
    .nav-links {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.3s;
    }
    .nav-links a:hover { color: var(--text-primary); }
    .nav-links .active { color: var(--accent-gold); }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s;
    }
    .btn-primary {
      background: var(--accent-purple);
      color: white;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    /* Header */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .page-header h1 .emoji {
      font-size: 2rem;
    }
    .page-header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    
    /* Top 3 Podium */
    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 50px;
      padding: 0 20px;
    }
    .podium-place {
      text-align: center;
      flex: 1;
      max-width: 180px;
    }
    .podium-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      position: relative;
    }
    .podium-place.first .podium-avatar {
      width: 100px;
      height: 100px;
      font-size: 2.2rem;
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #000;
      box-shadow: 0 0 30px rgba(255,215,0,0.4);
    }
    .podium-place.second .podium-avatar {
      background: linear-gradient(135deg, #c0c0c0, #e0e0e0);
      color: #000;
    }
    .podium-place.third .podium-avatar {
      background: linear-gradient(135deg, #cd7f32, #e5a04d);
      color: #000;
    }
    .podium-crown {
      position: absolute;
      top: -25px;
      font-size: 1.5rem;
    }
    .podium-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    .podium-score {
      color: var(--accent-gold);
      font-weight: 700;
      font-size: 1.3rem;
    }
    .podium-bar {
      margin-top: 15px;
      border-radius: 8px 8px 0 0;
    }
    .podium-place.first .podium-bar {
      height: 120px;
      background: linear-gradient(180deg, var(--accent-gold), #b8860b);
    }
    .podium-place.second .podium-bar {
      height: 90px;
      background: linear-gradient(180deg, #c0c0c0, #808080);
    }
    .podium-place.third .podium-bar {
      height: 60px;
      background: linear-gradient(180deg, #cd7f32, #8b4513);
    }
    .podium-rank {
      color: white;
      font-size: 2rem;
      font-weight: 800;
      padding-top: 15px;
    }
    
    /* Full Leaderboard */
    .leaderboard-card {
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .leaderboard-header {
      padding: 20px 25px;
      background: rgba(139,92,246,0.1);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .leaderboard-header h2 {
      font-size: 1.2rem;
    }
    .leaderboard-tabs {
      display: flex;
      gap: 10px;
    }
    .leaderboard-tab {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
    }
    .leaderboard-tab.active {
      background: var(--accent-purple);
      color: white;
    }
    
    .leaderboard-list {
      padding: 10px;
    }
    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.3s;
    }
    .leaderboard-item:hover {
      background: rgba(255,255,255,0.03);
    }
    .leaderboard-item.highlight {
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
    }
    .leaderboard-rank {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .leaderboard-rank.gold { background: var(--accent-gold); color: #000; }
    .leaderboard-rank.silver { background: #c0c0c0; color: #000; }
    .leaderboard-rank.bronze { background: #cd7f32; color: #000; }
    
    .leaderboard-user {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .leaderboard-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .leaderboard-name {
      font-weight: 600;
    }
    .leaderboard-username {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .leaderboard-stats {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .stat-value.gold { color: var(--accent-gold); }
    .stat-value.green { color: var(--accent-green); }
    .stat-value.cyan { color: var(--accent-cyan); }
    .stat-label {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    .empty-state h3 {
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    .empty-state a {
      color: var(--accent-cyan);
      text-decoration: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .podium { flex-wrap: wrap; }
      .podium-place { max-width: 140px; }
      .leaderboard-stats { display: none; }
      .nav-links { display: none; }
    }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="index.html" class="logo">üé¨ Video<span>Bate</span></a>
    <div class="nav-links">
      <a href="fallacies.html">üìö Learn</a>
      <a href="quiz.html">üéÆ Play</a>
      <a href="leaderboard.html" class="active">üèÜ Leaderboard</a>
      <a href="profile.html">üë§ Profile</a>
    </div>
    <a href="login.html" class="btn btn-primary" id="authBtn">Sign In</a>
  </nav>

  <div class="container">
    
    <div class="page-header">
      <h1><span class="emoji">üèÜ</span> Leaderboard</h1>
      <p>Top fallacy spotters ranked by total score</p>
    </div>
    
    <!-- Local vs Global Toggle -->
    <div style="display: flex; justify-content: center; margin-bottom: 30px;">
      <div style="display: flex; background: var(--bg-card); border-radius: 10px; padding: 5px;">
        <button class="scope-tab active" data-scope="local" onclick="switchScope('local')" style="padding: 12px 24px; border: none; background: var(--accent-purple); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">üíª Local Browser</button>
        <button class="scope-tab" data-scope="global" onclick="switchScope('global')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">üåê Global</button>
      </div>
    </div>
    
    <p id="scopeDesc" style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">Rankings from accounts in this browser only</p>
    
    <!-- Podium for Top 3 -->
    <div class="podium" id="podium">
      <!-- Populated by JS -->
    </div>
    
    <!-- Full Leaderboard -->
    <div class="leaderboard-card">
      <div class="leaderboard-header">
        <h2>üìä All Rankings</h2>
        <div class="leaderboard-tabs">
          <button class="leaderboard-tab active" data-sort="score">By Score</button>
          <button class="leaderboard-tab" data-sort="accuracy">By Accuracy</button>
          <button class="leaderboard-tab" data-sort="games">By Games</button>
        </div>
      </div>
      
      <div class="leaderboard-list" id="leaderboardList">
        <!-- Populated by JS -->
      </div>
    </div>
    
  </div>

<script>
// ========== USER SYSTEM ==========
function getUsers() {
  return JSON.parse(localStorage.getItem('fallacySpotter_users') || '[]');
}

function getCurrentUser() {
  return JSON.parse(localStorage.getItem('fallacySpotter_currentUser') || 'null');
}

// ========== CHECK AUTH ==========
const currentUser = getCurrentUser();
if (currentUser) {
  document.getElementById('authBtn').textContent = currentUser.firstName;
  document.getElementById('authBtn').href = 'profile.html';
}

// ========== LEADERBOARD ==========
let currentSort = 'score';
let currentScope = 'local';

function switchScope(scope) {
  currentScope = scope;
  
  // Update tab styling
  document.querySelectorAll('.scope-tab').forEach(tab => {
    if (tab.dataset.scope === scope) {
      tab.style.background = 'var(--accent-purple)';
      tab.style.color = 'white';
      tab.classList.add('active');
    } else {
      tab.style.background = 'transparent';
      tab.style.color = 'var(--text-secondary)';
      tab.classList.remove('active');
    }
  });
  
  // Update description
  document.getElementById('scopeDesc').textContent = scope === 'local' 
    ? 'Rankings from accounts in this browser only'
    : 'Global rankings from all players (updated by admin)';
  
  loadLeaderboard();
}

function loadLeaderboard() {
  if (currentScope === 'global') {
    loadGlobalLeaderboard();
  } else {
    loadLocalLeaderboard();
  }
}

function loadLocalLeaderboard() {
  let users = getUsers();
  
  if (users.length === 0) {
    document.getElementById('podium').innerHTML = '';
    document.getElementById('leaderboardList').innerHTML = `
      <div class="empty-state">
        <div class="icon">üèÜ</div>
        <h3>No Players Yet</h3>
        <p>Be the first to play and claim the top spot!<br>
        <a href="login.html">Create an account</a> or <a href="quiz.html">play as guest</a></p>
      </div>
    `;
    return;
  }
  
  // Sort users
  if (currentSort === 'score') {
    users.sort((a, b) => b.stats.totalScore - a.stats.totalScore);
  } else if (currentSort === 'accuracy') {
    users.sort((a, b) => {
      const accA = (a.stats.correctAnswers + a.stats.wrongAnswers) > 0 
        ? a.stats.correctAnswers / (a.stats.correctAnswers + a.stats.wrongAnswers) : 0;
      const accB = (b.stats.correctAnswers + b.stats.wrongAnswers) > 0 
        ? b.stats.correctAnswers / (b.stats.correctAnswers + b.stats.wrongAnswers) : 0;
      return accB - accA;
    });
  } else if (currentSort === 'games') {
    users.sort((a, b) => b.stats.gamesPlayed - a.stats.gamesPlayed);
  }
  
  // Render podium (top 3)
  renderPodium(users.slice(0, 3));
  
  // Render full list
  renderLeaderboard(users);
}

function loadGlobalLeaderboard() {
  const liveUrl = localStorage.getItem('fallacySpotter_liveDataUrl');
  
  if (liveUrl) {
    // Fetch live data from Apps Script
    fetchLiveLeaderboard(liveUrl);
  } else {
    // Fall back to locally stored CSV data
    loadStoredGlobalLeaderboard();
  }
}

async function fetchLiveLeaderboard(url) {
  // Show loading state
  document.getElementById('leaderboardList').innerHTML = `
    <div class="empty-state">
      <div class="icon">üîÑ</div>
      <h3>Loading Live Data...</h3>
      <p>Fetching latest scores from the server</p>
    </div>
  `;
  document.getElementById('podium').innerHTML = '';
  
  try {
    const response = await fetch(url);
    const games = await response.json();
    
    if (!Array.isArray(games) || games.length === 0) {
      document.getElementById('leaderboardList').innerHTML = `
        <div class="empty-state">
          <div class="icon">üåê</div>
          <h3>No Global Data Yet</h3>
          <p>Play quizzes to submit your scores!</p>
        </div>
      `;
      return;
    }
    
    // Aggregate by username
    const playerStats = {};
    games.forEach(game => {
      const key = (game.username || 'unknown').toLowerCase();
      if (key === 'unknown') return;
      
      if (!playerStats[key]) {
        playerStats[key] = {
          username: game.username,
          displayName: game.displayName || game.username,
          totalScore: 0,
          totalGames: 0,
          bestScore: 0,
          bestStreak: 0,
          lastPlayed: game.timestamp
        };
      }
      
      const score = parseInt(game.score) || 0;
      const streak = parseInt(game.streak) || 0;
      
      playerStats[key].totalScore += score;
      playerStats[key].totalGames++;
      if (score > playerStats[key].bestScore) playerStats[key].bestScore = score;
      if (streak > playerStats[key].bestStreak) playerStats[key].bestStreak = streak;
      if (new Date(game.timestamp) > new Date(playerStats[key].lastPlayed)) {
        playerStats[key].lastPlayed = game.timestamp;
      }
    });
    
    const players = Object.values(playerStats);
    
    // Sort
    if (currentSort === 'score') {
      players.sort((a, b) => b.bestScore - a.bestScore);
    } else if (currentSort === 'games') {
      players.sort((a, b) => b.totalGames - a.totalGames);
    } else {
      players.sort((a, b) => b.bestScore - a.bestScore);
    }
    
    // Render
    renderGlobalPodium(players.slice(0, 3));
    renderGlobalLeaderboard(players);
    
    // Update description with live indicator
    document.getElementById('scopeDesc').innerHTML = 'üü¢ <span style="color: var(--accent-green);">LIVE</span> - Fetched ' + games.length + ' games from ' + players.length + ' players';
    
  } catch (err) {
    console.error('Failed to fetch live leaderboard:', err);
    document.getElementById('leaderboardList').innerHTML = `
      <div class="empty-state">
        <div class="icon">‚ö†Ô∏è</div>
        <h3>Failed to Load Live Data</h3>
        <p>Error: ${err.message}<br>Showing cached data instead...</p>
      </div>
    `;
    // Fall back to stored data
    setTimeout(() => loadStoredGlobalLeaderboard(), 2000);
  }
}

function loadStoredGlobalLeaderboard() {
  const data = JSON.parse(localStorage.getItem('fallacySpotter_globalLeaderboard') || '{}');
  const players = Object.values(data);
  
  if (players.length === 0) {
    document.getElementById('podium').innerHTML = '';
    document.getElementById('leaderboardList').innerHTML = `
      <div class="empty-state">
        <div class="icon">üåê</div>
        <h3>No Global Data Yet</h3>
        <p>Global leaderboard is updated by the admin.<br>
        Play quizzes to submit your scores, then check back later!</p>
      </div>
    `;
    return;
  }
  
  // Sort by best score (or other criteria)
  if (currentSort === 'score') {
    players.sort((a, b) => b.bestScore - a.bestScore);
  } else if (currentSort === 'accuracy') {
    players.sort((a, b) => b.bestScore - a.bestScore); // Use best score as proxy
  } else if (currentSort === 'games') {
    players.sort((a, b) => b.totalGames - a.totalGames);
  }
  
  // Render podium (top 3)
  renderGlobalPodium(players.slice(0, 3));
  
  // Render full list
  renderGlobalLeaderboard(players);
}

function renderGlobalPodium(top3) {
  if (top3.length < 1) {
    document.getElementById('podium').innerHTML = '';
    return;
  }
  
  let html = '';
  
  // Second place (left)
  if (top3[1]) {
    html += createGlobalPodiumPlace(top3[1], 2, 'second');
  }
  
  // First place (center)
  if (top3[0]) {
    html += createGlobalPodiumPlace(top3[0], 1, 'first');
  }
  
  // Third place (right)
  if (top3[2]) {
    html += createGlobalPodiumPlace(top3[2], 3, 'third');
  }
  
  document.getElementById('podium').innerHTML = html;
}

function createGlobalPodiumPlace(player, rank, className) {
  const initials = player.displayName.substring(0, 2).toUpperCase();
  return `
    <div class="podium-place ${className}">
      <div class="podium-avatar">
        ${rank === 1 ? '<span class="podium-crown">üëë</span>' : ''}
        ${initials}
      </div>
      <div class="podium-name">${player.displayName}</div>
      <div class="podium-score">${player.bestScore.toLocaleString()} pts</div>
      <div class="podium-bar">
        <div class="podium-rank">${rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â'}</div>
      </div>
    </div>
  `;
}

function renderGlobalLeaderboard(players) {
  const html = players.map((player, index) => {
    const initials = player.displayName.substring(0, 2).toUpperCase();
    const rank = index + 1;
    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
    const avgScore = player.totalGames > 0 ? Math.round(player.totalScore / player.totalGames) : 0;
    
    return `
      <div class="leaderboard-item">
        <div class="leaderboard-rank ${rankClass}">${rank}</div>
        <div class="leaderboard-user">
          <div class="leaderboard-avatar">${initials}</div>
          <div>
            <div class="leaderboard-name">${player.displayName}</div>
            <div class="leaderboard-username">@${player.username}</div>
          </div>
        </div>
        <div class="leaderboard-stats">
          <div class="stat-item">
            <div class="stat-value gold">${player.bestScore.toLocaleString()}</div>
            <div class="stat-label">Best Score</div>
          </div>
          <div class="stat-item">
            <div class="stat-value green">${avgScore}</div>
            <div class="stat-label">Avg Score</div>
          </div>
          <div class="stat-item">
            <div class="stat-value cyan">${player.totalGames}</div>
            <div class="stat-label">Games</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('leaderboardList').innerHTML = html;
}

function renderPodium(top3) {
  if (top3.length < 1) {
    document.getElementById('podium').innerHTML = '';
    return;
  }
  
  const positions = ['second', 'first', 'third'];
  const displayOrder = [top3[1], top3[0], top3[2]].filter(Boolean);
  
  let html = '';
  
  // Second place (left)
  if (top3[1]) {
    html += createPodiumPlace(top3[1], 2, 'second');
  }
  
  // First place (center)
  if (top3[0]) {
    html += createPodiumPlace(top3[0], 1, 'first');
  }
  
  // Third place (right)
  if (top3[2]) {
    html += createPodiumPlace(top3[2], 3, 'third');
  }
  
  document.getElementById('podium').innerHTML = html;
}

function createPodiumPlace(user, rank, className) {
  const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
  return `
    <div class="podium-place ${className}">
      <div class="podium-avatar">
        ${rank === 1 ? '<span class="podium-crown">üëë</span>' : ''}
        ${initials}
      </div>
      <div class="podium-name">${user.firstName} ${user.lastName}</div>
      <div class="podium-score">${user.stats.totalScore.toLocaleString()} pts</div>
      <div class="podium-bar">
        <div class="podium-rank">${rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â'}</div>
      </div>
    </div>
  `;
}

function renderLeaderboard(users) {
  const html = users.map((user, index) => {
    const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
    const rank = index + 1;
    const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
    const isCurrentUser = currentUser && user.id === currentUser.id;
    
    const totalAnswers = user.stats.correctAnswers + user.stats.wrongAnswers;
    const accuracy = totalAnswers > 0 ? Math.round((user.stats.correctAnswers / totalAnswers) * 100) : 0;
    
    return `
      <div class="leaderboard-item ${isCurrentUser ? 'highlight' : ''}">
        <div class="leaderboard-rank ${rankClass}">${rank}</div>
        <div class="leaderboard-user">
          <div class="leaderboard-avatar">${initials}</div>
          <div>
            <div class="leaderboard-name">${user.firstName} ${user.lastName} ${isCurrentUser ? '(You)' : ''}</div>
            <div class="leaderboard-username">@${user.username}</div>
          </div>
        </div>
        <div class="leaderboard-stats">
          <div class="stat-item">
            <div class="stat-value gold">${user.stats.totalScore.toLocaleString()}</div>
            <div class="stat-label">Score</div>
          </div>
          <div class="stat-item">
            <div class="stat-value green">${accuracy}%</div>
            <div class="stat-label">Accuracy</div>
          </div>
          <div class="stat-item">
            <div class="stat-value cyan">${user.stats.gamesPlayed}</div>
            <div class="stat-label">Games</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('leaderboardList').innerHTML = html;
}

// ========== TAB SWITCHING ==========
document.querySelectorAll('.leaderboard-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentSort = tab.dataset.sort;
    loadLeaderboard();
  });
});

// ========== INIT ==========
loadLeaderboard();
</script>

</body>
</html>
