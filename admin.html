<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - VideoBate</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
  <style>
    :root {
      --bg-dark: #0f0f14;
      --bg-card: #1a1a24;
      --bg-card-hover: #252532;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-red: #ef4444;
      --accent-gold: #ffd700;
      --accent-cyan: #00d4ff;
      --accent-green: #22c55e;
      --accent-purple: #8b5cf6;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    
    /* Nav */
    .nav {
      background: rgba(15, 15, 20, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 0;
      position: sticky;
      top: 36px;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .nav-container { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.4rem; font-weight: 800; color: var(--accent-red); text-decoration: none; }
    .logo span { color: var(--text-primary); }
    .nav-links { display: flex; gap: 20px; align-items: center; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
    .nav-links a:hover { color: var(--text-primary); }
    
    /* User Menu */
    .user-menu { position: relative; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent-red), var(--accent-purple));
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px;
    }
    .user-dropdown {
      position: absolute; top: 100%; right: 0;
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 8px 0;
      min-width: 180px;
      display: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .user-menu:hover .user-dropdown { display: block; }
    .user-dropdown a {
      display: block;
      padding: 10px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
    }
    .user-dropdown a:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
    
    /* Admin Layout */
    .admin-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 120px);
      margin-top: 20px;
    }
    
    /* Sidebar */
    .admin-sidebar {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      height: fit-content;
      position: sticky;
      top: 100px;
    }
    .sidebar-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 15px;
      padding: 0 12px;
    }
    .sidebar-nav { display: flex; flex-direction: column; gap: 5px; }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
    }
    .sidebar-nav a:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
    .sidebar-nav a.active { background: rgba(239,68,68,0.15); color: var(--accent-red); }
    .sidebar-nav .icon { font-size: 18px; }
    
    /* Main Content */
    .admin-main {
      padding: 0 30px;
    }
    .admin-header {
      margin-bottom: 30px;
    }
    .admin-header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    .admin-header p { color: var(--text-secondary); }
    
    /* Tabs */
    .admin-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 25px;
      padding: 5px;
      background: var(--bg-card);
      border-radius: 12px;
      width: fit-content;
    }
    .admin-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .admin-tab:hover { color: var(--text-primary); }
    .admin-tab.active { background: var(--accent-red); color: white; }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-red), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-label { color: var(--text-secondary); margin-top: 5px; }
    
    /* Form Styles */
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-dark);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-red);
    }
    
    /* Toggle Switch */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-info label { font-weight: 500; margin-bottom: 3px; display: block; }
    .toggle-info span { font-size: 13px; color: var(--text-secondary); }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 26px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle input:checked + .toggle-slider { background: var(--accent-green); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(24px); }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .btn-primary { background: var(--accent-red); color: white; }
    .btn-primary:hover { background: #dc2626; }
    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
    }
    .btn-secondary:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--accent-red); }
    .btn-danger:hover { background: var(--accent-red); color: white; }
    
    /* Database Location Grid */
    .db-location-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .db-location-card {
      background: var(--bg-dark);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .db-location-card:hover { border-color: rgba(255,255,255,0.2); }
    .db-location-card.active {
      border-color: var(--accent-green);
      background: rgba(34,197,94,0.1);
    }
    .db-loc-icon { font-size: 24px; margin-bottom: 10px; }
    .db-loc-info h5 { font-size: 14px; margin-bottom: 5px; }
    .db-loc-info p { font-size: 12px; color: var(--text-secondary); }
    .db-loc-badge {
      display: inline-block;
      padding: 3px 10px;
      background: var(--accent-green);
      color: white;
      border-radius: 10px;
      font-size: 11px;
      margin-top: 10px;
    }
    
    /* SQL Workspace */
    .sql-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .sql-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sql-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .sql-workspace {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .sql-tables-panel {
      background: var(--bg-dark);
      border-radius: 12px;
      padding: 15px;
    }
    .sql-query-panel {
      background: var(--bg-dark);
      border-radius: 12px;
      padding: 15px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .panel-header h4 { font-size: 14px; }
    #sql-query-input {
      width: 100%;
      height: 150px;
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      color: var(--text-primary);
      font-family: 'Fira Code', monospace;
      font-size: 13px;
      resize: vertical;
    }
    .query-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      align-items: center;
    }
    .sql-results-panel {
      background: var(--bg-dark);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .results-container {
      max-height: 300px;
      overflow: auto;
    }
    .sql-results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .sql-results-table th, .sql-results-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .sql-results-table th { background: var(--bg-card); font-weight: 600; }
    .tables-list { max-height: 300px; overflow-y: auto; }
    .table-item {
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .table-item:hover { background: rgba(255,255,255,0.05); }
    .table-count { color: var(--text-secondary); font-size: 11px; margin-left: auto; }
    
    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th, .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .users-table th { color: var(--text-secondary); font-weight: 600; font-size: 12px; text-transform: uppercase; }
    .role-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .role-badge.admin { background: rgba(239,68,68,0.2); color: var(--accent-red); }
    .role-badge.user { background: rgba(0,212,255,0.2); color: var(--accent-cyan); }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      display: none;
      z-index: 9999;
    }
    .toast.show { display: block; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Responsive */
    @media (max-width: 768px) {
      .admin-container { grid-template-columns: 1fr; }
      .admin-sidebar { margin-bottom: 20px; position: static; }
      .sql-workspace { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- AIUNITES Webring -->
  <style>.aiunites-bar{position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(90deg,#0a0a0f,#1a1a2e);border-bottom:1px solid rgba(99,102,241,.3);padding:8px 0;font-size:12px}.aiunites-bar-content{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;align-items:center;gap:12px;overflow-x:auto;scrollbar-width:none}.aiunites-bar-content::-webkit-scrollbar{display:none}.aiunites-bar a{color:rgba(255,255,255,.7);text-decoration:none;white-space:nowrap;transition:color .2s}.aiunites-bar a:hover{color:#fff}.aiunites-bar-brand{color:#6366f1!important;font-weight:600}body{padding-top:36px!important}</style>
  <div class="aiunites-bar">
    <div class="aiunites-bar-content">
      <a href="https://aiunites.github.io/aiunites-site/" class="aiunites-bar-brand">‚óÜ AIUNITES</a>
      <span style="color:rgba(255,255,255,.2)">|</span>
      <a href="https://aiunites.github.io/aizines-app/">AIZines</a>
      <a href="https://aiunites.github.io/DemoTemplate/">DemoTemplate</a>
      <a href="https://aiunites.github.io/videobate-site/">VideoBate</a>
    </div>
  </div>

  <nav class="nav">
    <div class="container nav-container">
      <a href="index.html" class="logo">üé¨ Video<span>Bate</span></a>
      <div class="nav-links">
        <a href="fallacies.html">üéØ Fallacy Spotter</a>
        <a href="quiz.html">üß† Quiz</a>
        <div class="user-menu" id="userMenu">
          <span id="userName">Admin</span>
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-dropdown">
            <a href="admin.html">üõ°Ô∏è Admin Panel</a>
            <a href="#" id="settingsLink">‚öôÔ∏è Settings</a>
            <a href="#" id="logoutLink">üö™ Log Out</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-title">Admin Menu</div>
        <nav class="sidebar-nav">
          <a href="#" class="active" data-section="dashboard"><span class="icon">üìä</span> Dashboard</a>
          <a href="#" data-section="database"><span class="icon">üóÉÔ∏è</span> SQL Database</a>
          <a href="#" data-section="users"><span class="icon">üë•</span> Users</a>
          <a href="#" data-section="settings"><span class="icon">‚öôÔ∏è</span> Settings</a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="tab-content active">
          <div class="admin-header">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <p>VideoBate administration and management</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalUsers">0</div>
              <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="siteUsers">0</div>
              <div class="stat-label">VideoBate Users</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="dbStatus">--</div>
              <div class="stat-label">Database Status</div>
            </div>
          </div>

          <div class="card">
            <h3>üêô GitHub Sync Settings</h3>
            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">Save/load database to <code>AIUNITES/AIUNITES-database-sync/data/app.db</code></p>
            <div class="form-group">
              <label>GitHub Personal Access Token</label>
              <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
              <small style="color: var(--text-secondary); display: block; margin-top: 5px;">Needs <code>repo</code> write access. <a href="https://github.com/settings/tokens/new?scopes=repo&description=AIUNITES-database-sync" target="_blank" style="color: var(--accent-cyan);">Create token ‚Üí</a></small>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-primary" id="saveGithubTokenBtn">Save Token</button>
              <button class="btn btn-secondary" id="clearGithubTokenBtn">Clear Token</button>
            </div>
            <div id="tokenStatus" style="margin-top: 10px; font-size: 13px;"></div>
          </div>

          <div class="card">
            <h3>üîó Quick Links</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
              <a href="fallacies.html" class="btn btn-secondary">üéØ Fallacy Spotter</a>
              <a href="quiz.html" class="btn btn-secondary">üß† Quiz</a>
              <a href="index.html" class="btn btn-secondary">üè† Homepage</a>
              <a href="login.html?debug=1" class="btn btn-secondary">üîß Login Debug</a>
            </div>
          </div>
        </section>

        <!-- Database Section -->
        <section id="database-section" class="tab-content">
          <div class="admin-header">
            <h1>üóÉÔ∏è SQL Database</h1>
            <p>Manage the shared AIUNITES database</p>
          </div>

          <div class="card">
            <h3>üåê Database Location</h3>
            <div class="db-location-grid">
              <div class="db-location-card active" data-location="browser">
                <div class="db-loc-icon">üíª</div>
                <div class="db-loc-info">
                  <h5>Browser</h5>
                  <p>Stored in localStorage</p>
                </div>
                <span class="db-loc-badge">Active</span>
              </div>
              <div class="db-location-card" data-location="github">
                <div class="db-loc-icon">üêô</div>
                <div class="db-loc-info">
                  <h5>GitHub Sync</h5>
                  <p>AIUNITES/AIUNITES-database-sync</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="sql-header">
              <div class="sql-status">
                <span id="sql-status-icon">‚ö™</span>
                <span id="sql-status-text">Checking database...</span>
              </div>
              <div class="sql-actions">
                <button class="btn btn-secondary" id="newDbBtn">‚ûï New Database</button>
                <label class="btn btn-secondary" style="cursor: pointer;">
                  üìÇ Load .db
                  <input type="file" id="loadDbFile" accept=".db,.sqlite,.sqlite3" hidden>
                </label>
                <button class="btn btn-secondary" id="saveDbBtn">üíæ Save to File</button>
                <button class="btn btn-secondary" id="saveGitHubBtn">üêô Save to GitHub</button>
                <button class="btn btn-secondary" id="loadGitHubBtn">üì• Load from GitHub</button>
              </div>
            </div>

            <div class="sql-workspace">
              <div class="sql-tables-panel">
                <div class="panel-header">
                  <h4>üóÇÔ∏è Tables</h4>
                  <button class="btn btn-secondary" id="refreshTablesBtn" style="padding: 5px 10px; font-size: 12px;">üîÑ</button>
                </div>
                <div class="tables-list" id="tablesList">
                  <div style="color: var(--text-secondary); font-size: 13px;">No tables</div>
                </div>
              </div>
              <div class="sql-query-panel">
                <div class="panel-header">
                  <h4>üìù SQL Query</h4>
                </div>
                <textarea id="sql-query-input" placeholder="SELECT * FROM users WHERE site = 'videobate';"></textarea>
                <div class="query-buttons">
                  <button class="btn btn-primary" id="runQueryBtn">‚ñ∂Ô∏è Run</button>
                  <button class="btn btn-secondary" id="clearQueryBtn">Clear</button>
                  <span id="queryTime" style="color: var(--text-secondary); font-size: 12px;"></span>
                </div>
              </div>
            </div>

            <div class="sql-results-panel">
              <div class="panel-header">
                <h4>üìä Results</h4>
                <span id="resultsCount" style="color: var(--text-secondary); font-size: 12px;"></span>
              </div>
              <div class="results-container" id="resultsContainer">
                <div style="color: var(--text-secondary);">Run a query to see results</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Users Section -->
        <section id="users-section" class="tab-content">
          <div class="admin-header">
            <h1>üë• Users</h1>
            <p>All users from ALL AIUNITES sites (shared database)</p>
          </div>

          <div class="card">
            <h3>üìã User List <span id="userCount" style="color: var(--text-secondary); font-size: 14px;">(0 users)</span></h3>
            <div style="overflow-x: auto; margin-top: 15px;">
              <table class="users-table" id="usersTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Site</th>
                    <th>Username</th>
                    <th>Display Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Last Login</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="tab-content">
          <div class="admin-header">
            <h1>‚öôÔ∏è Settings</h1>
            <p>Configure VideoBate settings</p>
          </div>

          <div class="card">
            <h3>üîê Registration Settings</h3>
            <div class="toggle-row">
              <div class="toggle-info">
                <label>Allow Public Signup</label>
                <span>Anyone can create an account</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="publicSignup" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div class="toggle-info">
                <label>Require Email Verification</label>
                <span>Users must verify email before access</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="emailVerification">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="card">
            <h3>üéÆ Game Settings</h3>
            <div class="form-group">
              <label>Default Quiz Time (seconds)</label>
              <input type="number" id="quizTime" value="30" min="10" max="120">
            </div>
            <div class="form-group">
              <label>Points per Correct Answer</label>
              <input type="number" id="pointsCorrect" value="100" min="10" max="1000">
            </div>
          </div>

          <div class="card">
            <h3>üóëÔ∏è Danger Zone</h3>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">These actions cannot be undone.</p>
            <button class="btn btn-danger" id="clearCacheBtn">Clear Local Cache</button>
            <button class="btn btn-danger" id="resetDataBtn" style="margin-left: 10px;">Reset All Data</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
  <script src="js/sql-database.js"></script>
  <script>
    // Check auth
    (function() {
      const user = JSON.parse(localStorage.getItem('fallacySpotter_currentUser') || 'null');
      if (!user || user.role !== 'admin') {
        window.location.href = 'login.html';
        return;
      }
      
      // Update user display
      document.getElementById('userName').textContent = user.firstName || user.username || 'Admin';
      const initials = (user.firstName?.[0] || '') + (user.lastName?.[0] || '');
      document.getElementById('userAvatar').textContent = initials || 'A';
    })();

    // Logout
    document.getElementById('logoutLink').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('fallacySpotter_currentUser');
      window.location.href = 'login.html';
    });

    // Settings link
    document.getElementById('settingsLink').addEventListener('click', function(e) {
      e.preventDefault();
      showSection('settings');
    });

    // Sidebar navigation
    document.querySelectorAll('.sidebar-nav a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.dataset.section;
        showSection(section);
      });
    });

    function showSection(section) {
      document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
      document.querySelector(`.sidebar-nav a[data-section="${section}"]`)?.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(`${section}-section`)?.classList.add('active');
    }

    // Toast
    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.borderColor = type === 'success' ? 'var(--accent-green)' : type === 'error' ? 'var(--accent-red)' : 'var(--accent-cyan)';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Initialize database
    async function initAdmin() {
      try {
        await SQLDatabase.init();
        updateDashboard();
        refreshTables();
        loadUsers();
      } catch (e) {
        console.error('Init error:', e);
      }
    }

    function updateDashboard() {
      const status = SQLDatabase.getStatus();
      document.getElementById('totalUsers').textContent = status.totalUsers || 0;
      document.getElementById('siteUsers').textContent = status.userCount || 0;
      document.getElementById('dbStatus').textContent = status.loaded ? '‚úÖ' : '‚ùå';
      
      document.getElementById('sql-status-icon').textContent = status.loaded ? 'üü¢' : '‚ö™';
      document.getElementById('sql-status-text').textContent = status.loaded ? 'Database ready' : 'No database';
    }

    function refreshTables() {
      const list = document.getElementById('tablesList');
      if (!SQLDatabase.db) {
        list.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No database loaded</div>';
        return;
      }
      
      try {
        const result = SQLDatabase.db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
        if (!result.length || !result[0].values.length) {
          list.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No tables</div>';
          return;
        }
        
        let html = '';
        result[0].values.forEach(([name]) => {
          let count = 0;
          try {
            const c = SQLDatabase.db.exec(`SELECT COUNT(*) FROM "${name}"`);
            count = c[0]?.values[0]?.[0] || 0;
          } catch(e) {}
          html += `<div class="table-item" onclick="selectTable('${name}')">
            <span>üìã</span> ${name} <span class="table-count">${count} rows</span>
          </div>`;
        });
        list.innerHTML = html;
      } catch (e) {
        list.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">Error loading tables</div>';
      }
    }

    function selectTable(name) {
      document.getElementById('sql-query-input').value = `SELECT * FROM "${name}" LIMIT 100;`;
      runQuery();
    }

    function loadUsers() {
      // Use getAllUsersAllSites to show users from ALL sites
      const users = SQLDatabase.getAllUsersAllSites ? SQLDatabase.getAllUsersAllSites() : SQLDatabase.getAllUsers();
      const tbody = document.getElementById('usersTableBody');
      const count = document.getElementById('userCount');
      
      count.textContent = `(${users.length} users from all sites)`;
      
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No users found</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${u.id}</td>
          <td><span class="role-badge" style="background: ${u.site === 'videobate' ? 'rgba(239,68,68,0.2)' : 'rgba(139,92,246,0.2)'}; color: ${u.site === 'videobate' ? 'var(--accent-red)' : 'var(--accent-purple)'}">${u.site || 'unknown'}</span></td>
          <td>${u.username}</td>
          <td>${u.displayName || '-'}</td>
          <td>${u.email || '-'}</td>
          <td><span class="role-badge ${u.role}">${u.role}</span></td>
          <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-'}</td>
          <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : '-'}</td>
        </tr>
      `).join('');
    }

    function runQuery() {
      const query = document.getElementById('sql-query-input').value.trim();
      if (!query || !SQLDatabase.db) return;
      
      const start = performance.now();
      try {
        const results = SQLDatabase.db.exec(query);
        const time = (performance.now() - start).toFixed(2);
        document.getElementById('queryTime').textContent = `${time}ms`;
        
        displayResults(results);
        SQLDatabase.autoSave();
        refreshTables();
        loadUsers();
        updateDashboard();
      } catch (e) {
        document.getElementById('resultsContainer').innerHTML = `<div style="color: var(--accent-red);">‚ùå Error: ${e.message}</div>`;
        document.getElementById('resultsCount').textContent = '';
      }
    }

    function displayResults(results) {
      const container = document.getElementById('resultsContainer');
      const count = document.getElementById('resultsCount');
      
      if (!results.length) {
        container.innerHTML = '<div style="color: var(--accent-green);">‚úÖ Query executed (no results)</div>';
        count.textContent = '';
        return;
      }
      
      let total = 0;
      let html = '';
      results.forEach(r => {
        total += r.values.length;
        html += '<table class="sql-results-table"><thead><tr>';
        r.columns.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        r.values.forEach(row => {
          html += '<tr>';
          row.forEach(cell => html += `<td>${cell === null ? '<em style="color: var(--text-secondary);">NULL</em>' : cell}</td>`);
          html += '</tr>';
        });
        html += '</tbody></table>';
      });
      
      container.innerHTML = html;
      count.textContent = `${total} row${total !== 1 ? 's' : ''}`;
    }

    // Event listeners
    document.getElementById('runQueryBtn').addEventListener('click', runQuery);
    document.getElementById('clearQueryBtn').addEventListener('click', () => {
      document.getElementById('sql-query-input').value = '';
    });
    document.getElementById('refreshTablesBtn').addEventListener('click', refreshTables);

    document.getElementById('newDbBtn').addEventListener('click', () => {
      if (confirm('Create new empty database? This will clear current data.')) {
        SQLDatabase.createNewDatabase();
        SQLDatabase.ensureUsersTable();
        updateDashboard();
        refreshTables();
        loadUsers();
        showToast('New database created', 'success');
      }
    });

    document.getElementById('loadDbFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const buffer = await file.arrayBuffer();
      const data = new Uint8Array(buffer);
      SQLDatabase.db = new SQLDatabase.SQL.Database(data);
      SQLDatabase.isLoaded = true;
      SQLDatabase.autoSave();
      updateDashboard();
      refreshTables();
      loadUsers();
      showToast('Database loaded: ' + file.name, 'success');
    });

    document.getElementById('saveDbBtn').addEventListener('click', () => {
      if (!SQLDatabase.db) {
        showToast('No database to save', 'error');
        return;
      }
      const data = SQLDatabase.db.export();
      const blob = new Blob([data], { type: 'application/x-sqlite3' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `videobate_${Date.now()}.db`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Database saved', 'success');
    });

    document.getElementById('loadGitHubBtn').addEventListener('click', async () => {
      showToast('Loading from GitHub...', 'info');
      const loaded = await SQLDatabase.autoLoadFromGitHub();
      if (loaded) {
        await SQLDatabase.ensureUsersTable();
        updateDashboard();
        refreshTables();
        loadUsers();
        showToast('Loaded from GitHub!', 'success');
      } else {
        showToast('Could not load from GitHub', 'error');
      }
    });

    document.getElementById('saveGitHubBtn').addEventListener('click', async () => {
      // Check if token exists
      let token = localStorage.getItem('github_token');
      
      if (!token) {
        token = prompt('Enter your GitHub Personal Access Token (needs repo write access):');
        if (!token) {
          showToast('GitHub token required', 'error');
          return;
        }
        // Save token for future use
        if (confirm('Save token for future use? (stored in localStorage)')) {
          SQLDatabase.setGitHubToken(token);
        }
      }
      
      showToast('Saving to GitHub...', 'info');
      const saved = await SQLDatabase.saveToGitHub(token);
      if (saved) {
        showToast('Database saved to GitHub!', 'success');
      } else {
        showToast('Failed to save to GitHub. Check console for details.', 'error');
      }
    });

    document.getElementById('clearCacheBtn').addEventListener('click', () => {
      if (confirm('Clear local cache? You will need to reload from GitHub.')) {
        localStorage.removeItem(SQLDatabase.STORAGE_KEY);
        showToast('Cache cleared', 'success');
      }
    });

    document.getElementById('resetDataBtn').addEventListener('click', () => {
      if (confirm('Reset ALL data? This cannot be undone!')) {
        localStorage.clear();
        showToast('All data cleared. Reloading...', 'success');
        setTimeout(() => location.reload(), 1500);
      }
    });

    // Keyboard shortcut
    document.getElementById('sql-query-input').addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runQuery();
      }
    });

    // Init
    initAdmin();
    
    // Check and display GitHub token status
    function updateTokenStatus() {
      const status = document.getElementById('tokenStatus');
      const tokenInput = document.getElementById('githubToken');
      const hasToken = SQLDatabase.hasGitHubToken();
      
      if (hasToken) {
        status.innerHTML = '<span style="color: var(--accent-green);">‚úÖ Token configured</span>';
        tokenInput.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      } else {
        status.innerHTML = '<span style="color: var(--accent-orange);">‚ö†Ô∏è No token set - Save to GitHub will prompt for one</span>';
      }
    }
    updateTokenStatus();
    
    document.getElementById('saveGithubTokenBtn').addEventListener('click', () => {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        showToast('Please enter a token', 'error');
        return;
      }
      SQLDatabase.setGitHubToken(token);
      document.getElementById('githubToken').value = '';
      updateTokenStatus();
      showToast('GitHub token saved!', 'success');
    });
    
    document.getElementById('clearGithubTokenBtn').addEventListener('click', () => {
      if (confirm('Clear saved GitHub token?')) {
        SQLDatabase.setGitHubToken(null);
        updateTokenStatus();
        showToast('Token cleared', 'success');
      }
    });
  </script>
</body>
</html>
