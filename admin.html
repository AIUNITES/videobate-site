<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | Fallacy Spotter - VideoBate</title>
  <meta name="description" content="Admin dashboard for managing users, questions, and content.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
  <style>
    :root {
      --bg-dark: #0f0f14;
      --bg-card: #1a1a24;
      --bg-input: #252535;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-red: #ef4444;
      --accent-gold: #ffd700;
      --accent-cyan: #00d4ff;
      --accent-green: #22c55e;
      --accent-purple: #8b5cf6;
      --accent-orange: #f97316;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Layout */
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-right: 1px solid rgba(255,255,255,0.05);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 20px;
    }
    .sidebar-logo {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--accent-red);
      text-decoration: none;
      display: block;
      margin-bottom: 5px;
    }
    .sidebar-logo span { color: var(--text-primary); }
    .sidebar-subtitle {
      color: var(--accent-gold);
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .sidebar-nav {
      list-style: none;
    }
    .sidebar-nav li a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }
    .sidebar-nav li a:hover {
      background: rgba(255,255,255,0.03);
      color: var(--text-primary);
    }
    .sidebar-nav li a.active {
      background: rgba(139,92,246,0.1);
      color: var(--accent-purple);
      border-left-color: var(--accent-purple);
    }
    .sidebar-nav li a .icon {
      font-size: 1.2rem;
    }
    
    .sidebar-section {
      padding: 15px 20px 10px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .sidebar-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
      background: var(--bg-card);
    }
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sidebar-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .sidebar-user-info {
      flex: 1;
    }
    .sidebar-user-name {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .sidebar-user-role {
      color: var(--accent-red);
      font-size: 0.75rem;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 30px;
    }
    
    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .top-actions {
      display: flex;
      gap: 12px;
    }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 25px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .stat-card .label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 2.2rem;
      font-weight: 800;
    }
    .stat-card .value.purple { color: var(--accent-purple); }
    .stat-card .value.green { color: var(--accent-green); }
    .stat-card .value.gold { color: var(--accent-gold); }
    .stat-card .value.cyan { color: var(--accent-cyan); }
    .stat-card .change {
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .stat-card .change.up { color: var(--accent-green); }
    .stat-card .change.down { color: var(--accent-red); }
    
    /* Table */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    th {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tr:hover {
      background: rgba(255,255,255,0.02);
    }
    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar-sm {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .role-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .role-badge.admin {
      background: rgba(239,68,68,0.2);
      color: var(--accent-red);
    }
    .role-badge.user {
      background: rgba(139,92,246,0.2);
      color: var(--accent-purple);
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    .btn-primary {
      background: var(--accent-purple);
      color: white;
    }
    .btn-primary:hover {
      background: #7c3aed;
    }
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-primary);
    }
    .btn-secondary:hover {
      background: #333;
    }
    .btn-danger {
      background: rgba(239,68,68,0.2);
      color: var(--accent-red);
    }
    .btn-danger:hover {
      background: var(--accent-red);
      color: white;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    
    /* Action Buttons in Table */
    .action-btns {
      display: flex;
      gap: 8px;
    }
    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .action-btn.edit {
      background: rgba(0,212,255,0.2);
      color: var(--accent-cyan);
    }
    .action-btn.edit:hover {
      background: var(--accent-cyan);
      color: white;
    }
    .action-btn.delete {
      background: rgba(239,68,68,0.2);
      color: var(--accent-red);
    }
    .action-btn.delete:hover {
      background: var(--accent-red);
      color: white;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 5px;
      background: var(--bg-dark);
      padding: 5px;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .tab.active {
      background: var(--accent-purple);
      color: white;
    }
    .tab:hover:not(.active) {
      color: var(--text-primary);
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    .form-select {
      cursor: pointer;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: var(--accent-red);
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    /* Search & Filter */
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    .empty-state h3 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>

  <div class="admin-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">üé¨ Video<span>Bate</span></a>
        <div class="sidebar-subtitle">‚öôÔ∏è Admin Panel</div>
      </div>
      
      <nav>
        <ul class="sidebar-nav">
          <li><a href="#" class="active" data-tab="dashboard"><span class="icon">üìä</span> Dashboard</a></li>
          <li><a href="#" data-tab="users"><span class="icon">üë•</span> Users</a></li>
          <li><a href="#" data-tab="questions"><span class="icon">‚ùì</span> Questions</a></li>
          <li><a href="#" data-tab="fallacies"><span class="icon">üìö</span> Fallacies</a></li>
          <li><a href="#" data-tab="reports"><span class="icon">üìà</span> Reports</a></li>
          <li><a href="#" data-tab="userdb"><span class="icon">‚òÅÔ∏è</span> User Database</a></li>
          <li><a href="#" data-tab="global"><span class="icon">üåê</span> Global Leaderboard</a></li>
        </ul>
        
        <div class="sidebar-section">Quick Links</div>
        <ul class="sidebar-nav">
          <li><a href="profile.html"><span class="icon">üë§</span> My Profile</a></li>
          <li><a href="quiz.html"><span class="icon">üéÆ</span> Play Quiz</a></li>
          <li><a href="fallacies.html"><span class="icon">üìñ</span> View Site</a></li>
        </ul>
      </nav>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-avatar" id="sidebarAvatar">?</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebarName">Admin</div>
            <div class="sidebar-user-role">Administrator</div>
          </div>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      
      <!-- DASHBOARD TAB -->
      <div class="tab-content active" id="dashboardTab">
        <div class="top-bar">
          <h1 class="page-title">üìä Dashboard</h1>
          <div class="top-actions">
            <button class="btn btn-secondary" onclick="location.reload()">üîÑ Refresh</button>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">Total Users</div>
            <div class="value purple" id="totalUsers">0</div>
            <div class="change up">‚Üë Active community</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Questions</div>
            <div class="value cyan" id="totalQuestions">25</div>
            <div class="change">In quiz database</div>
          </div>
          <div class="stat-card">
            <div class="label">Fallacy Types</div>
            <div class="value gold" id="totalFallacies">48</div>
            <div class="change">Documented</div>
          </div>
          <div class="stat-card">
            <div class="label">Games Played</div>
            <div class="value green" id="totalGames">0</div>
            <div class="change">All time</div>
          </div>
        </div>
        
        <!-- Recent Users -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üë• Recent Users</h3>
            <button class="btn btn-sm btn-secondary" onclick="switchTab('users')">View All ‚Üí</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Score</th>
                  <th>Joined</th>
                </tr>
              </thead>
              <tbody id="recentUsersTable">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üèÜ Top Players</h3>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>User</th>
                  <th>Score</th>
                  <th>Accuracy</th>
                  <th>Games</th>
                </tr>
              </thead>
              <tbody id="topPlayersTable">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- USERS TAB -->
      <div class="tab-content" id="usersTab">
        <div class="top-bar">
          <h1 class="page-title">üë• User Management</h1>
          <div class="top-actions">
            <button class="btn btn-primary" onclick="openModal('addUserModal')">+ Add User</button>
          </div>
        </div>
        
        <div class="card">
          <div class="search-bar">
            <input type="text" class="search-input" id="userSearch" placeholder="Search users by name, email, or username..." oninput="filterUsers()">
            <select class="form-select" style="width: auto;" id="roleFilter" onchange="filterUsers()">
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="user">User</option>
            </select>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Score</th>
                  <th>Games</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- QUESTIONS TAB -->
      <div class="tab-content" id="questionsTab">
        <div class="top-bar">
          <h1 class="page-title">‚ùì Question Bank</h1>
          <div class="top-actions">
            <button class="btn btn-primary" onclick="openModal('addQuestionModal')">+ Add Question</button>
          </div>
        </div>
        
        <div class="card">
          <div class="search-bar">
            <input type="text" class="search-input" id="questionSearch" placeholder="Search questions..." oninput="filterQuestions()">
            <select class="form-select" style="width: auto;" id="difficultyFilter" onchange="filterQuestions()">
              <option value="">All Difficulties</option>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Scenario (Preview)</th>
                  <th>Answer</th>
                  <th>Difficulty</th>
                  <th>Points</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="questionsTable">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- FALLACIES TAB -->
      <div class="tab-content" id="fallaciesTab">
        <div class="top-bar">
          <h1 class="page-title">üìö Fallacy Database</h1>
          <div class="top-actions">
            <button class="btn btn-primary" onclick="openModal('addFallacyModal')">+ Add Fallacy</button>
            <a href="fallacies.html" class="btn btn-secondary" target="_blank">View Library ‚Üí</a>
          </div>
        </div>
        
        <div class="card">
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            The fallacy database is currently stored in the HTML file. To add or edit fallacies, modify the <code>fallacies.html</code> file directly.
            In a production system, this would be stored in a database.
          </p>
          
          <div class="stats-grid" style="margin-bottom: 0;">
            <div class="stat-card">
              <div class="label">Total Fallacies</div>
              <div class="value gold">48</div>
            </div>
            <div class="stat-card">
              <div class="label">Categories</div>
              <div class="value purple">8</div>
            </div>
            <div class="stat-card">
              <div class="label">With ASCII Art</div>
              <div class="value cyan">48</div>
            </div>
          </div>
        </div>
        
        <!-- Categories List -->
        <div class="card">
          <h3 class="card-title" style="margin-bottom: 20px;">üìÇ Categories</h3>
          <table>
            <thead>
              <tr>
                <th>Icon</th>
                <th>Category</th>
                <th>Fallacy Count</th>
                <th>Color</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>üë§</td><td>Attack the Person</td><td>6</td><td><span style="color: #ef4444;">Red</span></td></tr>
              <tr><td>üêü</td><td>Misdirection</td><td>6</td><td><span style="color: #f97316;">Orange</span></td></tr>
              <tr><td>üéì</td><td>False Authority</td><td>6</td><td><span style="color: #8b5cf6;">Purple</span></td></tr>
              <tr><td>üß†</td><td>Logic Errors</td><td>6</td><td><span style="color: #00d4ff;">Cyan</span></td></tr>
              <tr><td>üé≠</td><td>Manipulation</td><td>6</td><td><span style="color: #ec4899;">Pink</span></td></tr>
              <tr><td>üó≥Ô∏è</td><td>Political Tactics</td><td>6</td><td><span style="color: #22c55e;">Green</span></td></tr>
              <tr><td>‚öîÔ∏è</td><td>Advanced Debate</td><td>6</td><td><span style="color: #fff;">White</span></td></tr>
              <tr><td>‚ö°</td><td>Causation Errors</td><td>6</td><td><span style="color: #f97316;">Orange</span></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- REPORTS TAB -->
      <div class="tab-content" id="reportsTab">
        <div class="top-bar">
          <h1 class="page-title">üìà Reports & Analytics</h1>
          <div class="top-actions">
            <button class="btn btn-secondary">üì• Export CSV</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">Total Score (All Users)</div>
            <div class="value gold" id="reportTotalScore">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Average Score</div>
            <div class="value purple" id="reportAvgScore">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Correct Answers</div>
            <div class="value green" id="reportCorrect">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Overall Accuracy</div>
            <div class="value cyan" id="reportAccuracy">0%</div>
          </div>
        </div>
        
        <div class="card">
          <h3 class="card-title" style="margin-bottom: 20px;">üìä User Performance Summary</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Total Score</th>
                  <th>Games</th>
                  <th>Correct</th>
                  <th>Wrong</th>
                  <th>Accuracy</th>
                  <th>Best Streak</th>
                </tr>
              </thead>
              <tbody id="reportTable">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- USER DATABASE TAB -->
      <div class="tab-content" id="userdbTab">
        <div class="top-bar">
          <h1 class="page-title">‚òÅÔ∏è Cloud User Database</h1>
        </div>
        
        <!-- Connection Status -->
        <div class="card" id="userDbStatusCard">
          <div class="card-header">
            <h3 class="card-title">üîå Connection Status</h3>
            <button class="btn btn-sm btn-secondary" onclick="testUserDbConnection()">üîÑ Test Connection</button>
          </div>
          <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-dark); border-radius: 8px;">
            <div id="userDbStatusDot" style="width: 16px; height: 16px; border-radius: 50%; background: var(--accent-orange);"></div>
            <div>
              <div style="font-weight: 600;" id="userDbStatusText">Not Configured</div>
              <div style="font-size: 0.85rem; color: var(--text-secondary);" id="userDbStatusDetail">Set up Google Sheets API below</div>
            </div>
          </div>
        </div>
        
        <!-- Hardcoded Form Info -->
        <div class="card" style="border: 1px solid var(--accent-gold); background: rgba(255,215,0,0.05);">
          <div class="card-header">
            <h3 class="card-title">üìù Google Form (Hardcoded)</h3>
            <span style="background: var(--accent-green); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">‚úÖ CONFIGURED</span>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 15px;">
            The app is configured to use your existing Help/Feedback form with packed data format.
          </p>
          <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
            <div style="margin-bottom: 8px;"><span style="color: var(--accent-cyan);">Form URL:</span> <span style="color: var(--text-secondary);">...1FAIpQLSeQUi49AdTBRjetz5MDFQgMIkm9-vOMb_ARKwYEz41j_Nfiwg...</span></div>
            <div style="margin-bottom: 8px;"><span style="color: var(--accent-cyan);">Email:</span> entry.904300305</div>
            <div style="margin-bottom: 8px;"><span style="color: var(--accent-cyan);">Source:</span> entry.2053726945</div>
            <div><span style="color: var(--accent-cyan);">Message:</span> entry.1759393763 <span style="color: var(--accent-gold);">‚Üê Packed data goes here</span></div>
          </div>
          <p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.85rem;">
            <strong>Data Format:</strong><br>
            <code style="background: #000; padding: 2px 6px; border-radius: 4px; color: var(--accent-green);">USER|username|email|password|firstName|lastName|role|createdAt</code><br>
            <code style="background: #000; padding: 2px 6px; border-radius: 4px; color: var(--accent-cyan);">SCORE|username|displayName|score|correct|wrong|streak|mode|timestamp</code>
          </p>
        </div>
        
        <!-- Apps Script URL for Reading Data -->
        <div class="card" style="border: 2px solid var(--accent-green); background: rgba(34,197,94,0.05);">
          <div class="card-header">
            <h3 class="card-title">üìö Apps Script API URL</h3>
            <span style="background: var(--accent-green); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">REQUIRED</span>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            This URL allows the app to fetch and parse users/scores from your Google Sheet.
          </p>
          
          <div class="form-group">
            <label class="form-label">Apps Script Web App URL</label>
            <input type="text" class="form-input" id="usersApiUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
          </div>
          
          <button class="btn btn-primary" onclick="saveUsersApiUrl()">üíæ Save API URL</button>
          <span id="usersApiStatus" style="margin-left: 15px;"></span>
          
          <details style="margin-top: 20px;" open>
            <summary style="cursor: pointer; color: var(--accent-cyan); font-weight: 600;">üìñ Apps Script Code (COPY THIS)</summary>
            <div style="background: var(--bg-dark); padding: 20px; border-radius: 8px; margin-top: 15px;">
              <p style="margin-bottom: 15px; font-size: 0.9rem;">In your Google Sheet (linked to the form), go to <strong>Extensions ‚Üí Apps Script</strong> and paste:</p>
              <pre style="background: #000; padding: 15px; border-radius: 8px; font-size: 0.7rem; overflow-x: auto; color: var(--accent-cyan); white-space: pre-wrap;">function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.toString().toLowerCase().trim());
  
  // Find the message column (contains packed data)
  const msgIdx = headers.findIndex(h => h.includes('message') || h.includes('feedback'));
  
  const users = [];
  const scores = [];
  
  data.slice(1).forEach(row => {
    const message = msgIdx >= 0 ? row[msgIdx] : '';
    if (!message || typeof message !== 'string') return;
    
    const parts = message.split('|');
    const type = parts[0];
    
    if (type === 'USER' && parts.length >= 8) {
      users.push({
        username: parts[1],
        email: parts[2],
        password: parts[3],
        firstName: parts[4],
        lastName: parts[5],
        role: parts[6] || 'user',
        createdAt: parts[7]
      });
    } else if (type === 'SCORE' && parts.length >= 9) {
      scores.push({
        username: parts[1],
        displayName: parts[2],
        score: parseInt(parts[3]) || 0,
        correct: parseInt(parts[4]) || 0,
        wrong: parseInt(parts[5]) || 0,
        streak: parseInt(parts[6]) || 0,
        mode: parts[7],
        timestamp: parts[8]
      });
    }
  });
  
  // Return based on ?type= parameter
  const requestType = e?.parameter?.type || 'users';
  const result = requestType === 'scores' ? scores : users;
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
              <p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-secondary);">
                <strong>Deploy:</strong> Click Deploy ‚Üí New deployment ‚Üí Web app ‚Üí "Anyone" can access ‚Üí Deploy<br>
                <strong>Copy the URL</strong> and paste it above!
              </p>
              <p style="margin-top: 10px; font-size: 0.85rem; color: var(--accent-gold);">
                <strong>Usage:</strong><br>
                ‚Ä¢ <code>?type=users</code> ‚Üí Returns user accounts<br>
                ‚Ä¢ <code>?type=scores</code> ‚Üí Returns quiz scores
              </p>
            </div>
          </details>
        </div>
        
        <!-- Users from Cloud -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üë• Cloud Users</h3>
            <button class="btn btn-sm btn-secondary" onclick="loadCloudUsers()">üîÑ Refresh</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody id="cloudUsersTable">
                <tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Configure API URL above, then click Refresh</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Cloud Scores -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üèÜ Cloud Scores</h3>
            <button class="btn btn-sm btn-secondary" onclick="loadCloudScores()">üîÑ Refresh</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Display Name</th>
                  <th>Score</th>
                  <th>Correct</th>
                  <th>Mode</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="cloudScoresTable">
                <tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">Configure API URL above, then click Refresh</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Setup Guide -->
        <div class="card" style="border: 1px solid var(--accent-cyan); background: rgba(0,212,255,0.05);">
          <h3 class="card-title" style="color: var(--accent-cyan); margin-bottom: 15px;">üìñ Quick Setup (3 Steps)</h3>
          <ol style="color: var(--text-secondary); line-height: 2.2; margin-left: 20px;">
            <li><strong>Open your Google Sheet</strong> (linked to your Help/Feedback form)</li>
            <li><strong>Add Apps Script</strong>: Extensions ‚Üí Apps Script ‚Üí paste code above ‚Üí Deploy as Web App</li>
            <li><strong>Paste URL above</strong> and click "Test Connection"</li>
          </ol>
          <p style="margin-top: 15px; padding: 15px; background: rgba(34,197,94,0.1); border-radius: 8px; font-size: 0.9rem;">
            ‚úÖ <strong>That's it!</strong> Registration and quiz scores will automatically submit to your form, and the API will parse them.
          </p>
        </div>
      </div>
      
      <!-- GLOBAL LEADERBOARD TAB -->
      <div class="tab-content" id="globalTab">
        <div class="top-bar">
          <h1 class="page-title">üåê Global Leaderboard</h1>
        </div>
        
        <!-- Google Form Setup -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìù Google Form Configuration</h3>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            Set up a Google Form to collect quiz results from all players. Results are submitted automatically when players complete a quiz.
          </p>
          
          <div class="form-group">
            <label class="form-label">Google Form Response URL</label>
            <input type="text" class="form-input" id="googleFormUrl" placeholder="https://docs.google.com/forms/d/e/FORM_ID/formResponse">
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">Get this from: Form ‚Üí Send ‚Üí Link (change /viewform to /formResponse)</p>
          </div>
          
          <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; color: var(--accent-cyan); margin-bottom: 15px;">Advanced: Entry IDs (click to expand)</summary>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
              To find entry IDs: Open form ‚Üí Pre-fill link ‚Üí Fill in test data ‚Üí Get link ‚Üí Look for "entry.XXXXXXX" in URL
            </p>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Username Entry ID</label>
                <input type="text" class="form-input" id="entryUsername" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Display Name Entry ID</label>
                <input type="text" class="form-input" id="entryDisplayName" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Score Entry ID</label>
                <input type="text" class="form-input" id="entryScore" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Correct Entry ID</label>
                <input type="text" class="form-input" id="entryCorrect" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Wrong Entry ID</label>
                <input type="text" class="form-input" id="entryWrong" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Streak Entry ID</label>
                <input type="text" class="form-input" id="entryStreak" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Mode Entry ID</label>
                <input type="text" class="form-input" id="entryMode" placeholder="entry.123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Timestamp Entry ID</label>
                <input type="text" class="form-input" id="entryTimestamp" placeholder="entry.123456789">
              </div>
            </div>
          </details>
          
          <button class="btn btn-primary" onclick="saveGoogleFormConfig()">üíæ Save Configuration</button>
          <span id="configStatus" style="margin-left: 15px; color: var(--accent-green);"></span>
        </div>
        
        <!-- LIVE DATA URL - NEW -->
        <div class="card" style="border: 2px solid var(--accent-green); background: rgba(34,197,94,0.05);">
          <div class="card-header">
            <h3 class="card-title">üîÑ Live Data URL (Automatic Updates!)</h3>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            <strong style="color: var(--accent-green);">‚ú® Recommended!</strong> Set up a Google Apps Script web app to serve live leaderboard data. The leaderboard will fetch fresh data automatically - no manual CSV uploads needed!
          </p>
          
          <div class="form-group">
            <label class="form-label">Apps Script Web App URL</label>
            <input type="text" class="form-input" id="liveDataUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">Deploy your Apps Script as a web app and paste the URL here</p>
          </div>
          
          <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="saveLiveDataUrl()">üíæ Save URL</button>
            <button class="btn btn-secondary" onclick="testLiveDataUrl()">üß™ Test Connection</button>
            <span id="liveDataStatus" style="margin-left: 10px;"></span>
          </div>
          
          <details>
            <summary style="cursor: pointer; color: var(--accent-cyan); margin-bottom: 15px;">üìñ How to Set Up Google Apps Script</summary>
            <div style="background: var(--bg-dark); padding: 20px; border-radius: 8px; margin-top: 10px;">
              <p style="margin-bottom: 15px;"><strong>Step 1:</strong> Open your Google Sheet (linked to Google Form responses)</p>
              <p style="margin-bottom: 15px;"><strong>Step 2:</strong> Go to Extensions ‚Üí Apps Script</p>
              <p style="margin-bottom: 15px;"><strong>Step 3:</strong> Delete existing code and paste this:</p>
              <pre style="background: #000; padding: 15px; border-radius: 8px; font-size: 0.8rem; overflow-x: auto; color: var(--accent-cyan);"><code>function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.toString().toLowerCase().trim());
  
  const results = data.slice(1).map(row => {
    return {
      timestamp: row[headers.indexOf('timestamp')] || new Date().toISOString(),
      username: row[headers.indexOf('username')] || 'unknown',
      displayName: row[headers.indexOf('display name')] || row[headers.indexOf('displayname')] || 'Unknown',
      score: parseInt(row[headers.indexOf('score')]) || 0,
      correct: parseInt(row[headers.indexOf('correct')] || row[headers.indexOf('correct answers')]) || 0,
      wrong: parseInt(row[headers.indexOf('wrong')] || row[headers.indexOf('wrong answers')]) || 0,
      streak: parseInt(row[headers.indexOf('streak')] || row[headers.indexOf('best streak')]) || 0,
      mode: row[headers.indexOf('mode')] || 'practice'
    };
  }).filter(r => r.username !== 'unknown');
  
  return ContentService
    .createTextOutput(JSON.stringify(results))
    .setMimeType(ContentService.MimeType.JSON);
}</code></pre>
              <p style="margin: 15px 0;"><strong>Step 4:</strong> Click Deploy ‚Üí New deployment</p>
              <p style="margin-bottom: 15px;"><strong>Step 5:</strong> Select type: "Web app"</p>
              <p style="margin-bottom: 15px;"><strong>Step 6:</strong> Set "Who has access" to "Anyone"</p>
              <p style="margin-bottom: 15px;"><strong>Step 7:</strong> Click Deploy and copy the Web app URL</p>
              <p><strong>Step 8:</strong> Paste the URL above and click Save!</p>
            </div>
          </details>
        </div>
        
        <!-- CSV Upload -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìÑ Upload Results CSV</h3>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            Download responses from Google Forms as CSV, then upload here to update the global leaderboard.
          </p>
          
          <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 20px;" id="dropZone">
            <div style="font-size: 3rem; margin-bottom: 15px;">üìÅ</div>
            <p style="margin-bottom: 15px;">Drag & drop CSV file here, or click to browse</p>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCsvUpload(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('csvFile').click()">üìÇ Choose File</button>
          </div>
          
          <div id="uploadStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
          
          <details>
            <summary style="cursor: pointer; color: var(--accent-cyan); margin-bottom: 10px;">Expected CSV Format</summary>
            <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
              <code>Timestamp,Username,Display Name,Score,Correct,Wrong,Streak,Mode</code><br>
              <code>2026-01-23T10:30:00Z,johndoe,John Doe,250,8,2,5,practice</code><br>
              <code>2026-01-23T11:15:00Z,janedoe,Jane Doe,300,10,0,10,timed</code>
            </div>
          </details>
        </div>
        
        <!-- Global Leaderboard Display -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üèÜ Global Rankings</h3>
            <div>
              <span id="lastUpdated" style="color: var(--text-secondary); font-size: 0.85rem; margin-right: 15px;"></span>
              <button class="btn btn-sm btn-secondary" onclick="refreshGlobalData()">üîÑ Refresh Live</button>
              <button class="btn btn-sm btn-danger" onclick="clearGlobalLeaderboard()">üóëÔ∏è Clear</button>
            </div>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Player</th>
                  <th>Best Score</th>
                  <th>Total Games</th>
                  <th>Avg Score</th>
                  <th>Best Streak</th>
                  <th>Last Played</th>
                </tr>
              </thead>
              <tbody id="globalLeaderboardTable">
                <tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">No data yet. Upload a CSV to populate the leaderboard.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Instructions Card -->
        <div class="card" style="border: 1px solid var(--accent-cyan); background: rgba(0,212,255,0.05);">
          <h3 class="card-title" style="color: var(--accent-cyan); margin-bottom: 15px;">üìñ How It Works</h3>
          <ol style="color: var(--text-secondary); line-height: 2; margin-left: 20px;">
            <li><strong>Create Google Form</strong> with fields: Username, Display Name, Score, Correct, Wrong, Streak, Mode, Timestamp</li>
            <li><strong>Configure above</strong> with your form's response URL and entry IDs</li>
            <li><strong>Players complete quizzes</strong> ‚Üí Results auto-submit to your Google Form</li>
            <li><strong>Download CSV</strong> from Google Forms (Responses ‚Üí Download as CSV)</li>
            <li><strong>Upload CSV here</strong> ‚Üí Global leaderboard updates!</li>
          </ol>
        </div>
      </div>
      
    </main>
  </div>
  
  <!-- Add User Modal -->
  <div class="modal-overlay" id="addUserModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚ûï Add New User</h3>
        <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
      </div>
      <form id="addUserForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">First Name</label>
            <input type="text" class="form-input" name="firstName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-input" name="lastName" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" name="username" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" name="email" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" name="password" required minlength="8">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" name="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create User</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add Question Modal -->
  <div class="modal-overlay" id="addQuestionModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚ûï Add New Question</h3>
        <button class="modal-close" onclick="closeModal('addQuestionModal')">&times;</button>
      </div>
      <form id="addQuestionForm">
        <div class="form-group">
          <label class="form-label">Scenario (HTML allowed)</label>
          <textarea class="form-textarea" name="scenario" required placeholder='<span class="scenario-speaker">Person:</span> "Quote here..."'></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Correct Answer (Code)</label>
            <input type="text" class="form-input" name="answer" required placeholder="e.g., STRW">
          </div>
          <div class="form-group">
            <label class="form-label">Difficulty</label>
            <select class="form-select" name="difficulty">
              <option value="easy">Easy (+10 pts)</option>
              <option value="medium">Medium (+25 pts)</option>
              <option value="hard">Hard (+50 pts)</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Wrong Options (comma-separated codes)</label>
          <input type="text" class="form-input" name="wrongOptions" required placeholder="e.g., RHER, FLSD, AUTH">
        </div>
        <div class="form-group">
          <label class="form-label">Explanation</label>
          <textarea class="form-textarea" name="explanation" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('addQuestionModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Question</button>
        </div>
      </form>
    </div>
  </div>

<script>
// ========== USER SYSTEM ==========
function getUsers() {
  return JSON.parse(localStorage.getItem('fallacySpotter_users') || '[]');
}

function saveUsers(users) {
  localStorage.setItem('fallacySpotter_users', JSON.stringify(users));
}

function getCurrentUser() {
  return JSON.parse(localStorage.getItem('fallacySpotter_currentUser') || 'null');
}

// ========== AUTH CHECK ==========
const currentUser = getCurrentUser();
if (!currentUser || currentUser.role !== 'admin') {
  alert('Access denied. Admin privileges required.');
  window.location.href = 'login.html';
}

// Populate sidebar
document.getElementById('sidebarAvatar').textContent = (currentUser.firstName[0] + currentUser.lastName[0]).toUpperCase();
document.getElementById('sidebarName').textContent = currentUser.firstName + ' ' + currentUser.lastName;

// ========== TAB SWITCHING ==========
document.querySelectorAll('.sidebar-nav a[data-tab]').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    switchTab(link.dataset.tab);
  });
});

function switchTab(tabName) {
  // Update sidebar
  document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
  document.querySelector(`.sidebar-nav a[data-tab="${tabName}"]`)?.classList.add('active');
  
  // Update content
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.getElementById(tabName + 'Tab')?.classList.add('active');
  
  // Load data for tab
  if (tabName === 'users') loadUsersTable();
  if (tabName === 'questions') loadQuestionsTable();
  if (tabName === 'reports') loadReports();
  if (tabName === 'userdb') testUserDbConnection();
}

// ========== MODAL ==========
function openModal(id) {
  document.getElementById(id).classList.add('show');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

// ========== DASHBOARD ==========
function loadDashboard() {
  const users = getUsers();
  
  document.getElementById('totalUsers').textContent = users.length;
  
  // Calculate total games
  let totalGames = users.reduce((sum, u) => sum + u.stats.gamesPlayed, 0);
  document.getElementById('totalGames').textContent = totalGames;
  
  // Recent users table
  const recentUsers = [...users].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
  document.getElementById('recentUsersTable').innerHTML = recentUsers.map(u => `
    <tr>
      <td>
        <div class="user-cell">
          <div class="user-avatar-sm">${(u.firstName[0] + u.lastName[0]).toUpperCase()}</div>
          ${u.firstName} ${u.lastName}
        </div>
      </td>
      <td>${u.email}</td>
      <td><span class="role-badge ${u.role}">${u.role}</span></td>
      <td>${u.stats.totalScore.toLocaleString()}</td>
      <td>${new Date(u.createdAt).toLocaleDateString()}</td>
    </tr>
  `).join('');
  
  // Top players table
  const topPlayers = [...users].sort((a, b) => b.stats.totalScore - a.stats.totalScore).slice(0, 5);
  document.getElementById('topPlayersTable').innerHTML = topPlayers.map((u, i) => {
    const total = u.stats.correctAnswers + u.stats.wrongAnswers;
    const accuracy = total > 0 ? Math.round((u.stats.correctAnswers / total) * 100) : 0;
    return `
      <tr>
        <td>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</td>
        <td>
          <div class="user-cell">
            <div class="user-avatar-sm">${(u.firstName[0] + u.lastName[0]).toUpperCase()}</div>
            ${u.firstName} ${u.lastName}
          </div>
        </td>
        <td style="color: var(--accent-gold); font-weight: 700;">${u.stats.totalScore.toLocaleString()}</td>
        <td>${accuracy}%</td>
        <td>${u.stats.gamesPlayed}</td>
      </tr>
    `;
  }).join('');
}

// ========== USERS TABLE ==========
function loadUsersTable() {
  const users = getUsers();
  renderUsersTable(users);
}

function renderUsersTable(users) {
  document.getElementById('usersTable').innerHTML = users.map(u => `
    <tr>
      <td>
        <div class="user-cell">
          <div class="user-avatar-sm">${(u.firstName[0] + u.lastName[0]).toUpperCase()}</div>
          ${u.firstName} ${u.lastName}
        </div>
      </td>
      <td>${u.email}</td>
      <td>@${u.username}</td>
      <td><span class="role-badge ${u.role}">${u.role}</span></td>
      <td>${u.stats.totalScore.toLocaleString()}</td>
      <td>${u.stats.gamesPlayed}</td>
      <td>${new Date(u.createdAt).toLocaleDateString()}</td>
      <td>
                <div class="action-btns">
          <button class="action-btn edit" onclick="resetPassword(${u.id})" title="Reset Password">üîë</button>
          <button class="action-btn edit" onclick="editUser(${u.id})" title="Edit">‚úèÔ∏è</button>
          <button class="action-btn delete" onclick="deleteUser(${u.id})" title="Delete">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function filterUsers() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const role = document.getElementById('roleFilter').value;
  
  let users = getUsers();
  
  if (search) {
    users = users.filter(u => 
      u.firstName.toLowerCase().includes(search) ||
      u.lastName.toLowerCase().includes(search) ||
      u.email.toLowerCase().includes(search) ||
      u.username.toLowerCase().includes(search)
    );
  }
  
  if (role) {
    users = users.filter(u => u.role === role);
  }
  
  renderUsersTable(users);
}

function deleteUser(id) {
  if (!confirm('Are you sure you want to delete this user?')) return;
  
  let users = getUsers();
  users = users.filter(u => u.id !== id);
  saveUsers(users);
  loadUsersTable();
  loadDashboard();
}

function editUser(id) {
  alert('Edit user modal - TODO: Implement full edit functionality');
}

function resetPassword(id) {
  const users = getUsers();
  const user = users.find(u => u.id === id);
  
  if (!user) {
    alert('User not found');
    return;
  }
  
  const newPassword = prompt(`Reset password for ${user.firstName} ${user.lastName} (@${user.username})\n\nEnter new password (min 8 characters):`);
  
  if (!newPassword) return;
  
  if (newPassword.length < 8) {
    alert('Password must be at least 8 characters');
    return;
  }
  
  user.password = newPassword;
  saveUsers(users);
  
  alert(`‚úÖ Password reset successfully!\n\nUsername: ${user.username}\nNew Password: ${newPassword}`);
}

// ========== ADD USER ==========
document.getElementById('addUserForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const form = e.target;
  const users = getUsers();
  
  const newUser = {
    id: Date.now(),
    firstName: form.firstName.value.trim(),
    lastName: form.lastName.value.trim(),
    username: form.username.value.trim(),
    email: form.email.value.trim(),
    password: form.password.value,
    role: form.role.value,
    createdAt: new Date().toISOString(),
    stats: {
      totalScore: 0,
      gamesPlayed: 0,
      correctAnswers: 0,
      wrongAnswers: 0,
      bestStreak: 0,
      badges: []
    }
  };
  
  users.push(newUser);
  saveUsers(users);
  
  closeModal('addUserModal');
  form.reset();
  loadUsersTable();
  loadDashboard();
  alert('User created successfully!');
});

// ========== QUESTIONS ==========
// Demo questions (in production, these would be in a database)
const questions = [
  { id: 1, scenario: 'Politician attacks opponent\'s character...', answer: 'CHAR', difficulty: 'easy', points: 10 },
  { id: 2, scenario: 'Parent uses slippery slope argument...', answer: 'SLIP', difficulty: 'easy', points: 10 },
  { id: 3, scenario: 'Debater creates straw man...', answer: 'STRW', difficulty: 'easy', points: 10 },
  { id: 4, scenario: 'Ad uses appeal to authority...', answer: 'AUTH', difficulty: 'easy', points: 10 },
  { id: 5, scenario: 'Person uses whataboutism...', answer: 'WHAT', difficulty: 'easy', points: 10 },
  { id: 6, scenario: 'Marketing uses appeal to popularity...', answer: 'POPUL', difficulty: 'easy', points: 10 },
  { id: 7, scenario: 'Conspiracy theorist uses argument from ignorance...', answer: 'IGNR', difficulty: 'medium', points: 25 },
  { id: 8, scenario: 'Interviewer asks loaded question...', answer: 'LOAD', difficulty: 'medium', points: 25 },
  { id: 9, scenario: 'Pundit poisons the well...', answer: 'WELL', difficulty: 'medium', points: 25 },
  { id: 10, scenario: 'Skeptic uses anecdotal evidence...', answer: 'ANEC', difficulty: 'medium', points: 25 },
];

function loadQuestionsTable() {
  renderQuestionsTable(questions);
}

function renderQuestionsTable(qs) {
  document.getElementById('questionsTable').innerHTML = qs.map((q, i) => `
    <tr>
      <td>${i + 1}</td>
      <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${q.scenario}</td>
      <td><code style="background: rgba(0,212,255,0.2); padding: 2px 8px; border-radius: 4px;">${q.answer}</code></td>
      <td><span class="role-badge" style="background: ${q.difficulty === 'easy' ? 'rgba(34,197,94,0.2)' : q.difficulty === 'medium' ? 'rgba(255,215,0,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${q.difficulty === 'easy' ? '#22c55e' : q.difficulty === 'medium' ? '#ffd700' : '#ef4444'};">${q.difficulty}</span></td>
      <td>+${q.points}</td>
      <td>
        <div class="action-btns">
          <button class="action-btn edit" title="Edit">‚úèÔ∏è</button>
          <button class="action-btn delete" title="Delete">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function filterQuestions() {
  const search = document.getElementById('questionSearch').value.toLowerCase();
  const difficulty = document.getElementById('difficultyFilter').value;
  
  let filtered = questions;
  
  if (search) {
    filtered = filtered.filter(q => q.scenario.toLowerCase().includes(search) || q.answer.toLowerCase().includes(search));
  }
  
  if (difficulty) {
    filtered = filtered.filter(q => q.difficulty === difficulty);
  }
  
  renderQuestionsTable(filtered);
}

// ========== REPORTS ==========
function loadReports() {
  const users = getUsers();
  
  let totalScore = 0, totalCorrect = 0, totalWrong = 0;
  
  users.forEach(u => {
    totalScore += u.stats.totalScore;
    totalCorrect += u.stats.correctAnswers;
    totalWrong += u.stats.wrongAnswers;
  });
  
  const totalAnswers = totalCorrect + totalWrong;
  const accuracy = totalAnswers > 0 ? Math.round((totalCorrect / totalAnswers) * 100) : 0;
  const avgScore = users.length > 0 ? Math.round(totalScore / users.length) : 0;
  
  document.getElementById('reportTotalScore').textContent = totalScore.toLocaleString();
  document.getElementById('reportAvgScore').textContent = avgScore.toLocaleString();
  document.getElementById('reportCorrect').textContent = totalCorrect.toLocaleString();
  document.getElementById('reportAccuracy').textContent = accuracy + '%';
  
  // Report table
  document.getElementById('reportTable').innerHTML = users.map(u => {
    const total = u.stats.correctAnswers + u.stats.wrongAnswers;
    const acc = total > 0 ? Math.round((u.stats.correctAnswers / total) * 100) : 0;
    return `
      <tr>
        <td>${u.firstName} ${u.lastName}</td>
        <td style="color: var(--accent-gold);">${u.stats.totalScore.toLocaleString()}</td>
        <td>${u.stats.gamesPlayed}</td>
        <td style="color: var(--accent-green);">${u.stats.correctAnswers}</td>
        <td style="color: var(--accent-red);">${u.stats.wrongAnswers}</td>
        <td>${acc}%</td>
        <td>${u.stats.bestStreak}</td>
      </tr>
    `;
  }).join('');
}

// ========== USER DATABASE (CLOUD) ==========

// Save Users API URL
function saveUsersApiUrl() {
  const url = document.getElementById('usersApiUrl').value.trim();
  localStorage.setItem('fallacySpotter_usersApiUrl', url);
  
  const status = document.getElementById('usersApiStatus');
  status.textContent = '‚úÖ Saved!';
  status.style.color = 'var(--accent-green)';
  setTimeout(() => status.textContent = '', 3000);
}

// Load Users API URL
function loadUsersApiUrl() {
  const url = localStorage.getItem('fallacySpotter_usersApiUrl') || '';
  document.getElementById('usersApiUrl').value = url;
}

// Test User DB Connection
async function testUserDbConnection() {
  const url = document.getElementById('usersApiUrl').value.trim();
  
  if (!url) {
    document.getElementById('userDbStatusDot').style.background = 'var(--accent-red)';
    document.getElementById('userDbStatusText').textContent = 'Not Configured';
    document.getElementById('userDbStatusDetail').textContent = 'Please enter an API URL first';
    return;
  }
  
  document.getElementById('userDbStatusDot').style.background = 'var(--accent-orange)';
  document.getElementById('userDbStatusText').textContent = 'Connecting...';
  document.getElementById('userDbStatusDetail').textContent = 'Testing connection to Google Sheets';
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    if (Array.isArray(data)) {
      document.getElementById('userDbStatusDot').style.background = 'var(--accent-green)';
      document.getElementById('userDbStatusText').textContent = 'Connected!';
      document.getElementById('userDbStatusDetail').textContent = `Found ${data.length} users in database`;
      
      // Also load the users table
      renderCloudUsersTable(data);
    } else {
      document.getElementById('userDbStatusDot').style.background = 'var(--accent-red)';
      document.getElementById('userDbStatusText').textContent = 'Invalid Response';
      document.getElementById('userDbStatusDetail').textContent = 'API did not return an array';
    }
  } catch (err) {
    document.getElementById('userDbStatusDot').style.background = 'var(--accent-red)';
    document.getElementById('userDbStatusText').textContent = 'Connection Failed';
    document.getElementById('userDbStatusDetail').textContent = err.message;
  }
}

// Load Cloud Users
async function loadCloudUsers() {
  const url = localStorage.getItem('fallacySpotter_usersApiUrl');
  
  if (!url) {
    document.getElementById('cloudUsersTable').innerHTML = 
      '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Configure API URL above first</td></tr>';
    return;
  }
  
  document.getElementById('cloudUsersTable').innerHTML = 
    '<tr><td colspan="5" style="text-align: center; color: var(--accent-cyan); padding: 40px;">üîÑ Loading...</td></tr>';
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    if (Array.isArray(data) && data.length > 0) {
      renderCloudUsersTable(data);
    } else {
      document.getElementById('cloudUsersTable').innerHTML = 
        '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">No users found in database</td></tr>';
    }
  } catch (err) {
    document.getElementById('cloudUsersTable').innerHTML = 
      `<tr><td colspan="5" style="text-align: center; color: var(--accent-red); padding: 40px;">‚ùå Error: ${err.message}</td></tr>`;
  }
}

// Render Cloud Users Table
function renderCloudUsersTable(users) {
  if (users.length === 0) {
    document.getElementById('cloudUsersTable').innerHTML = 
      '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">No users in database</td></tr>';
    return;
  }
  
  document.getElementById('cloudUsersTable').innerHTML = users.map(u => {
    const name = [u.firstName, u.lastName].filter(Boolean).join(' ') || 'N/A';
    const created = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A';
    const role = u.role || 'user';
    return `
      <tr>
        <td><strong>@${u.username || 'unknown'}</strong></td>
        <td>${u.email || 'N/A'}</td>
        <td>${name}</td>
        <td><span class="role-badge ${role}">${role}</span></td>
        <td>${created}</td>
      </tr>
    `;
  }).join('');
}

// Load Cloud Scores
async function loadCloudScores() {
  const url = localStorage.getItem('fallacySpotter_usersApiUrl');
  
  if (!url) {
    document.getElementById('cloudScoresTable').innerHTML = 
      '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">Configure API URL above first</td></tr>';
    return;
  }
  
  document.getElementById('cloudScoresTable').innerHTML = 
    '<tr><td colspan="6" style="text-align: center; color: var(--accent-cyan); padding: 40px;">üîÑ Loading...</td></tr>';
  
  try {
    const response = await fetch(url + '?type=scores');
    const data = await response.json();
    
    if (Array.isArray(data) && data.length > 0) {
      renderCloudScoresTable(data);
    } else {
      document.getElementById('cloudScoresTable').innerHTML = 
        '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">No scores found in database</td></tr>';
    }
  } catch (err) {
    document.getElementById('cloudScoresTable').innerHTML = 
      `<tr><td colspan="6" style="text-align: center; color: var(--accent-red); padding: 40px;">‚ùå Error: ${err.message}</td></tr>`;
  }
}

// Render Cloud Scores Table
function renderCloudScoresTable(scores) {
  if (scores.length === 0) {
    document.getElementById('cloudScoresTable').innerHTML = 
      '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 40px;">No scores in database</td></tr>';
    return;
  }
  
  // Sort by score descending
  scores.sort((a, b) => b.score - a.score);
  
  document.getElementById('cloudScoresTable').innerHTML = scores.slice(0, 50).map(s => {
    const timestamp = s.timestamp ? new Date(s.timestamp).toLocaleString() : 'N/A';
    return `
      <tr>
        <td><strong>@${s.username || 'unknown'}</strong></td>
        <td>${s.displayName || 'N/A'}</td>
        <td style="color: var(--accent-gold); font-weight: 600;">${s.score}</td>
        <td>${s.correct}/${s.correct + (s.wrong || 0)}</td>
        <td><span style="background: var(--bg-dark); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">${s.mode || 'practice'}</span></td>
        <td style="font-size: 0.85rem; color: var(--text-secondary);">${timestamp}</td>
      </tr>
    `;
  }).join('');
}

// ========== LIVE DATA URL ==========

function saveLiveDataUrl() {
  const url = document.getElementById('liveDataUrl').value.trim();
  localStorage.setItem('fallacySpotter_liveDataUrl', url);
  
  const status = document.getElementById('liveDataStatus');
  status.textContent = '‚úÖ Saved!';
  status.style.color = 'var(--accent-green)';
  setTimeout(() => status.textContent = '', 3000);
}

function loadLiveDataUrl() {
  const url = localStorage.getItem('fallacySpotter_liveDataUrl') || '';
  document.getElementById('liveDataUrl').value = url;
}

async function testLiveDataUrl() {
  const url = document.getElementById('liveDataUrl').value.trim();
  const status = document.getElementById('liveDataStatus');
  
  if (!url) {
    status.textContent = '‚ùå Please enter a URL first';
    status.style.color = 'var(--accent-red)';
    return;
  }
  
  status.textContent = 'üîÑ Testing...';
  status.style.color = 'var(--accent-cyan)';
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    if (Array.isArray(data)) {
      status.textContent = `‚úÖ Success! Found ${data.length} game records`;
      status.style.color = 'var(--accent-green)';
      
      // Preview data in console
      console.log('Live data preview:', data.slice(0, 5));
    } else {
      status.textContent = '‚ö†Ô∏è Response is not an array';
      status.style.color = 'var(--accent-orange)';
    }
  } catch (err) {
    status.textContent = '‚ùå Failed to fetch: ' + err.message;
    status.style.color = 'var(--accent-red)';
    console.error('Live data test error:', err);
  }
}

// ========== GLOBAL LEADERBOARD ==========

// Save Google Form Configuration
function saveGoogleFormConfig() {
  const url = document.getElementById('googleFormUrl').value.trim();
  
  const entryIds = {
    username: document.getElementById('entryUsername').value.trim(),
    displayName: document.getElementById('entryDisplayName').value.trim(),
    score: document.getElementById('entryScore').value.trim(),
    correct: document.getElementById('entryCorrect').value.trim(),
    wrong: document.getElementById('entryWrong').value.trim(),
    streak: document.getElementById('entryStreak').value.trim(),
    mode: document.getElementById('entryMode').value.trim(),
    timestamp: document.getElementById('entryTimestamp').value.trim()
  };
  
  localStorage.setItem('fallacySpotter_googleFormUrl', url);
  localStorage.setItem('fallacySpotter_formEntryIds', JSON.stringify(entryIds));
  
  document.getElementById('configStatus').textContent = '‚úÖ Saved!';
  setTimeout(() => document.getElementById('configStatus').textContent = '', 3000);
}

// Load Google Form Configuration
function loadGoogleFormConfig() {
  const url = localStorage.getItem('fallacySpotter_googleFormUrl') || '';
  const entryIds = JSON.parse(localStorage.getItem('fallacySpotter_formEntryIds') || '{}');
  
  document.getElementById('googleFormUrl').value = url;
  document.getElementById('entryUsername').value = entryIds.username || '';
  document.getElementById('entryDisplayName').value = entryIds.displayName || '';
  document.getElementById('entryScore').value = entryIds.score || '';
  document.getElementById('entryCorrect').value = entryIds.correct || '';
  document.getElementById('entryWrong').value = entryIds.wrong || '';
  document.getElementById('entryStreak').value = entryIds.streak || '';
  document.getElementById('entryMode').value = entryIds.mode || '';
  document.getElementById('entryTimestamp').value = entryIds.timestamp || '';
}

// CSV Upload Handler
function handleCsvUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const csv = e.target.result;
    parseCsvAndUpdateLeaderboard(csv);
  };
  reader.readAsText(file);
}

// Parse CSV and Update Leaderboard
function parseCsvAndUpdateLeaderboard(csv) {
  const lines = csv.split('\n').filter(line => line.trim());
  if (lines.length < 2) {
    showUploadStatus('error', 'CSV file is empty or invalid');
    return;
  }
  
  // Parse header to find column indices
  const header = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
  
  const cols = {
    timestamp: findColumnIndex(header, ['timestamp', 'date', 'time']),
    username: findColumnIndex(header, ['username', 'user', 'name']),
    displayName: findColumnIndex(header, ['display name', 'displayname', 'full name', 'fullname']),
    score: findColumnIndex(header, ['score', 'points']),
    correct: findColumnIndex(header, ['correct', 'correct answers']),
    wrong: findColumnIndex(header, ['wrong', 'wrong answers', 'incorrect']),
    streak: findColumnIndex(header, ['streak', 'best streak']),
    mode: findColumnIndex(header, ['mode', 'game mode'])
  };
  
  // Parse data rows
  const games = [];
  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length < 3) continue;
    
    games.push({
      timestamp: cols.timestamp >= 0 ? values[cols.timestamp] : new Date().toISOString(),
      username: cols.username >= 0 ? values[cols.username] : 'Unknown',
      displayName: cols.displayName >= 0 ? values[cols.displayName] : values[cols.username] || 'Unknown',
      score: cols.score >= 0 ? parseInt(values[cols.score]) || 0 : 0,
      correct: cols.correct >= 0 ? parseInt(values[cols.correct]) || 0 : 0,
      wrong: cols.wrong >= 0 ? parseInt(values[cols.wrong]) || 0 : 0,
      streak: cols.streak >= 0 ? parseInt(values[cols.streak]) || 0 : 0,
      mode: cols.mode >= 0 ? values[cols.mode] : 'practice'
    });
  }
  
  if (games.length === 0) {
    showUploadStatus('error', 'No valid game data found in CSV');
    return;
  }
  
  // Aggregate by username
  const playerStats = {};
  games.forEach(game => {
    const key = game.username.toLowerCase();
    if (!playerStats[key]) {
      playerStats[key] = {
        username: game.username,
        displayName: game.displayName,
        totalScore: 0,
        totalGames: 0,
        bestScore: 0,
        bestStreak: 0,
        lastPlayed: game.timestamp
      };
    }
    
    playerStats[key].totalScore += game.score;
    playerStats[key].totalGames++;
    if (game.score > playerStats[key].bestScore) playerStats[key].bestScore = game.score;
    if (game.streak > playerStats[key].bestStreak) playerStats[key].bestStreak = game.streak;
    if (new Date(game.timestamp) > new Date(playerStats[key].lastPlayed)) {
      playerStats[key].lastPlayed = game.timestamp;
    }
  });
  
  // Save to localStorage
  localStorage.setItem('fallacySpotter_globalLeaderboard', JSON.stringify(playerStats));
  localStorage.setItem('fallacySpotter_globalLeaderboardUpdated', new Date().toISOString());
  
  showUploadStatus('success', `‚úÖ Imported ${games.length} games from ${Object.keys(playerStats).length} players!`);
  loadGlobalLeaderboard();
}

// Helper: Parse CSV Line (handles quoted values)
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current.trim());
  return result;
}

// Helper: Find column index by possible names
function findColumnIndex(header, possibleNames) {
  for (const name of possibleNames) {
    const idx = header.indexOf(name);
    if (idx >= 0) return idx;
  }
  return -1;
}

// Show upload status
function showUploadStatus(type, message) {
  const el = document.getElementById('uploadStatus');
  el.style.display = 'block';
  el.style.background = type === 'success' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)';
  el.style.color = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
  el.textContent = message;
}

// Load Global Leaderboard
function loadGlobalLeaderboard() {
  const data = JSON.parse(localStorage.getItem('fallacySpotter_globalLeaderboard') || '{}');
  const updated = localStorage.getItem('fallacySpotter_globalLeaderboardUpdated');
  
  if (updated) {
    document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date(updated).toLocaleString();
  }
  
  const players = Object.values(data).sort((a, b) => b.bestScore - a.bestScore);
  
  if (players.length === 0) {
    document.getElementById('globalLeaderboardTable').innerHTML = 
      '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">No data yet. Upload a CSV to populate the leaderboard.</td></tr>';
    return;
  }
  
  document.getElementById('globalLeaderboardTable').innerHTML = players.map((p, i) => {
    const avgScore = Math.round(p.totalScore / p.totalGames);
    return `
      <tr>
        <td>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</td>
        <td>
          <div class="user-cell">
            <div class="user-avatar-sm">${p.displayName.substring(0, 2).toUpperCase()}</div>
            <div>
              <div>${p.displayName}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary)">@${p.username}</div>
            </div>
          </div>
        </td>
        <td style="color: var(--accent-gold); font-weight: 700;">${p.bestScore}</td>
        <td>${p.totalGames}</td>
        <td>${avgScore}</td>
        <td>${p.bestStreak} üî•</td>
        <td style="font-size: 0.85rem;">${new Date(p.lastPlayed).toLocaleDateString()}</td>
      </tr>
    `;
  }).join('');
}

// Clear Global Leaderboard
function clearGlobalLeaderboard() {
  if (!confirm('Are you sure you want to clear all global leaderboard data?')) return;
  
  localStorage.removeItem('fallacySpotter_globalLeaderboard');
  localStorage.removeItem('fallacySpotter_globalLeaderboardUpdated');
  loadGlobalLeaderboard();
  showUploadStatus('success', 'Leaderboard cleared!');
}

// Refresh global data from live URL
async function refreshGlobalData() {
  const url = localStorage.getItem('fallacySpotter_liveDataUrl');
  if (!url) {
    showUploadStatus('error', 'No Live Data URL configured. Set one up above!');
    return;
  }
  
  showUploadStatus('success', 'üîÑ Fetching live data...');
  
  try {
    const response = await fetch(url);
    const games = await response.json();
    
    if (!Array.isArray(games)) {
      showUploadStatus('error', 'Invalid response from server');
      return;
    }
    
    // Aggregate by username
    const playerStats = {};
    games.forEach(game => {
      const key = (game.username || 'unknown').toLowerCase();
      if (key === 'unknown') return;
      
      if (!playerStats[key]) {
        playerStats[key] = {
          username: game.username,
          displayName: game.displayName || game.username,
          totalScore: 0,
          totalGames: 0,
          bestScore: 0,
          bestStreak: 0,
          lastPlayed: game.timestamp
        };
      }
      
      const score = parseInt(game.score) || 0;
      const streak = parseInt(game.streak) || 0;
      
      playerStats[key].totalScore += score;
      playerStats[key].totalGames++;
      if (score > playerStats[key].bestScore) playerStats[key].bestScore = score;
      if (streak > playerStats[key].bestStreak) playerStats[key].bestStreak = streak;
      if (new Date(game.timestamp) > new Date(playerStats[key].lastPlayed)) {
        playerStats[key].lastPlayed = game.timestamp;
      }
    });
    
    // Save to localStorage
    localStorage.setItem('fallacySpotter_globalLeaderboard', JSON.stringify(playerStats));
    localStorage.setItem('fallacySpotter_globalLeaderboardUpdated', new Date().toISOString());
    
    showUploadStatus('success', `‚úÖ Refreshed! ${games.length} games from ${Object.keys(playerStats).length} players`);
    loadGlobalLeaderboard();
    
  } catch (err) {
    showUploadStatus('error', 'Failed to fetch: ' + err.message);
  }
}

// Drag and Drop support
const dropZone = document.getElementById('dropZone');
if (dropZone) {
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--accent-cyan)';
    dropZone.style.background = 'rgba(0,212,255,0.1)';
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
    dropZone.style.background = 'transparent';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
    dropZone.style.background = 'transparent';
    
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      const reader = new FileReader();
      reader.onload = (ev) => parseCsvAndUpdateLeaderboard(ev.target.result);
      reader.readAsText(file);
    } else {
      showUploadStatus('error', 'Please upload a CSV file');
    }
  });
}

// ========== INIT ==========
loadDashboard();
loadGoogleFormConfig();
loadLiveDataUrl();
loadGlobalLeaderboard();
loadUsersApiUrl();
</script>

</body>
</html>
